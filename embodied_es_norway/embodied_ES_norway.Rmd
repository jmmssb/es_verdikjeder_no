---
title: "Embodied Ecosystem Services | Norway"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: cosmo
    code_folding: hide
---

```{css, echo=FALSE}
table {
  float: left;
}
```

Magnus Merkle (SSB), with Marte Lindseth (SSB) and Kristine Grimsrud (SSB)

Naturregnskapsprosjekt, 12. December 2025

\

# Changelog

Changes since version 0:

-   Set up first version

# Abstract and limitation

In this notebook we apply the quantified ecosystem services in Norway to its national input-output table in order to compute embodied quantities in final demand.

# 1. Filepaths and functions

```{r, results = 'hide', message = FALSE, warning=FALSE}
# make space
rm(list = ls())
# packages
library(dplyr)
library(tidyr)
library(openxlsx)
library(readxl)
library(Rfast)
library(ggplot2)
library(here)
library(writexl)
# filepath to the wd
wfp<-file.path(here::here())
# filepath to ecosystem service data
efp<-file.path(here::here(),"embodied_es_norway","Allocating regulating services to A64")
# filepath to IO data
dfp<-file.path(here::here(),"embodied_es_norway")
```

# 2. Get data

In this section we run scripts to import data, aggregate it to the desired resolution, and match it in preparation for the subsequent analysis.

## 2.1 Import and format IO data

Here we import SSB's input-output data for the year 2023, at A64 resolution. Given that certain sectors are grouped together (for confidentiality reasons), we need to work with a slightly lower resolution than the full A64.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# Import IO data
fiot <- read_excel(file.path(dfp,"IOT_1750_2023_adj.xlsx"), 
                 sheet = "Adjusted")

# get sector identification vectors
sector_names<-colnames(fiot)[3:64]
sector_codes<-as.character(fiot[1,3:64])

# get intermediate transactions matrix
Z <- as.matrix(fiot[2:63,3:64])
class(Z)<-"numeric"

# get final demand vector
fd<-as.matrix(fiot[2:63,69])
class(fd)<-"numeric"

# get GCF vector
fc<-as.matrix(fiot[2:63,72])
class(fc)<-"numeric"

# get exports vector
fe<-as.matrix(fiot[2:63,73])
class(fe)<-"numeric"

# get total output vector
x<-as.matrix(fiot[2:63,75])
class(x)<-"numeric"

# get imports vector
vm <- as.matrix(fiot[74,3:64])
class(vm)<-"numeric"

# make an alternative version that includes trade as a sector of its own
# Zt<-cbind(rbind(Z,vm),rbind(fe,0))
# fct<-rbind(fc,0)
# fdt<-rbind(fd,0)
# xt<-rbind(x,sum(vm))

# clean up environment
rm(fiot)
```

## 2.2 Import and match ecosystem service data

This data comes from Naturregskapsprosjektet. It is a preliminary version of the Norwegian national ecosystem accounting, which will officially start in 2026.

The first thing we need to do is to create a sector concordance from A64 national accounts to IO tables from national accounts.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# concordance between sectors
scd<-as.data.frame(matrix(nrow=length(sector_codes),ncol=4))
colnames(scd)<-c("s_code","s_name","es_name","Comments")
scd$s_code<-sector_codes
scd$s_name<-sector_names
scd$es_name<-c("Crop and animal production, hunting and related service activities",
                  "Forestry and logging",
                  "Aquaculture",
                  "Mining and quarrying",
                  "Manufacture of food products, beverages and tobacco products",
                  "Manufacture of textiles, wearing apparel and leather products",
                  "Manufacture of wood and wood products, except furniture",
                  "Manufacture of paper and paper products",
                  "Printing and reproduction of recorded media",
                  "Refined petroleum, chemical and pharmaceutical products",
                  "Manufacture of rubber and plastic products",
                  "Manufacture of other non-metallic mineral products",
                  "Manufacture of basic metals",
                  "Fabricated metal products, except machinery and equipment",
                  "Manufacture of computer, electronic and optical products",
                  "Manufacture of electrical equipment",
                  "Manufacture of machinery and equipment n.e.c.",
                  "Manufacture of motor vehicles, trailers and semi-trailers",
                  "Building of ships, oil platforms and moduls",
                  "Manufacture of furniture",
                  "Repair and installation of machinery and equipment",
                  "Electricity, gas, steam and air conditioning supply",
                  "Water collection, treatment and supply",
                  "Sewerage",
                  "Construction",
                  "Wholesale and retail trade and repair of motor vehicles",
                  "Wholesale trade, except of motor vehicles",
                  "Retail trade, except of motor vehicles",
                  "Transport via pipelines",
                  "Ocean transport",
                  "Air transport",
                  "Warehousing and support activities for transportation",
                  "Postal and courier activities",
                  "Accommodation and food service activities",
                  "Publishing activities",
                  "Motion picture and video programme production, broadcasting",
                  "Telecommunications",
                  "Computer programming and related activities",
                  "Financial service activities, except insurance and pension funding",
                  "Insurance, except compulsory social security",
                  "Activities auxiliary to financial services and insurance activities",
                  "Real estate activities",
                  "Real estate activities",
                  "Legal and accounting activities",
                  "Architectural and engineering consultancy activities",
                  "Scientific research and development",
                  "Advertising and market research",
                  "Other professional, scientific and technical activities",
                  "Rental and leasing activities",
                  "Employment activities",
                  "Travel agency and tour operator reservation service",
                  "Security and investigation activities",
                  "Public administration and defence",
                  "Education",
                  "Human health activities",
                  "Social work activities",
                  "Creative, arts and entertainment activities",
                  "Sports activities and amusement and recreation activities",
                  "Activities of membership organisations",
                  "Repair of computers and personal and household goods",
                  "Other personal service activities",
                  "Activities of households as employers")

scd<-rbind(scd,
           c("R50","Water transport services","Inland water transport and supply","Need to aggregate"))     

scd<-rbind(scd,
           c("R49","Land transport services and transport services via pipelines","Land transport, except transport via pipelines","Need to aggregate"))     

scd<-rbind(scd,
           c("RB","Mining and quarrying","Oil and gas extraction","Need to aggregate"))     

scd<-rbind(scd,
           c("R19_R20_R21","Coke and refined petroleum products | Chemicals and chemical products| Basic pharmaceutical products and pharmaceutical preparations","Service activities incidental to oil and gas","Need to aggregate.")) 

scd<-rbind(scd,
           c("R03","Fish and other fishing products; aquaculture products; support services to fishing","Fishing","Need to aggregate")) 

scd$Comments[scd$s_code %in% c("R68A","R68B")]<-"Need to aggregate IO table here"
scd$Comments[scd$s_code %in% c("R50")]<-"Need to aggregate ES data here"
scd$Comments[scd$s_code %in% c("R49")]<-"Need to aggregate ES data here"
scd$Comments[scd$s_code %in% c("R19_R20_R21")]<-"Need to aggregate ES data here"
scd$Comments[scd$s_code %in% c("RB")]<-"Need to aggregate ES data here"
scd$Comments[scd$s_code %in% c("R03")]<-"Need to aggregate ES data here"

scd <- scd %>% mutate(s_code = factor(s_code,levels=sector_codes)) %>% arrange(s_code)
# save as excel
write_xlsx(scd,file.path(dfp,"IOT_A64_concordance.xlsx"))
```

It turns out that there is no perfect 1:1 match between the two different sector resolutions. In our IO data we need to aggregate R68A and R68B, and in our ecosystem service data we need to aggregate fishing and aquaculture, some mining sectors, refined petroleum sectors, and some transport categories. So we do that next. First aggregate the IO data.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# Aggregate IO data first
# so here we want to aggregate sector number 42 and 43 to one. The nice thing is that we can just sum across columns and rows.

# make an aggregator across rows
#define i as the first of the two sectors that should be aggregated and define j as the original size of the matrix
i=which(sector_codes=="R68B")
j=62
# then make a premult matrix to aggregate
aggr<-cbind(rbind(diag(i),
                  matrix(0,nrow=j-1-i,ncol=i)),
            rbind(matrix(0,nrow=i-1,ncol=j-i),
                  diag(j-i)))
# # the version with trade
# j=63
# aggtr<-cbind(rbind(diag(i),
#                   matrix(0,nrow=j-1-i,ncol=i)),
#             rbind(matrix(0,nrow=i-1,ncol=j-i),
#                   diag(j-i)))
# and then run
Zr<- aggr %*% Z
fcr<- aggr %*% fc
fdr<- aggr %*% fd
fer<- aggr %*% fe
xr<- aggr %*% x

# #version with trade
# Ztr<- aggtr %*% Zt
# fctr<- aggtr %*% fct
# fdtr<- aggtr %*% fdt
# xtr<- aggtr %*% xt

# and the aggregate columns
# this requires a postmultiplicator
i=which(sector_codes=="R68B")
j=62
aggc<-rbind(cbind(diag(i),matrix(0,nrow=i,ncol=j-i-1)),
            cbind(matrix(0,nrow=j-i,ncol=i-1),diag(j-i)))
# # version with trade
# j=63
# aggtc<-rbind(cbind(diag(i),matrix(0,nrow=i,ncol=j-i-1)),
#             cbind(matrix(0,nrow=j-i,ncol=i-1),diag(j-i)))
# and then run
Zrc <- Zr %*% aggc
vmc <- vm %*% aggc

# # version with trade
# Ztrc <- Ztr %*% aggtc

# new sector codes and names
j=62
sector_codes_c<-c(sector_codes[1:(i-1)],"R68",sector_codes[(i+2):j])
sector_names_c<-c(sector_names[1:(i-1)],"Real estate activities",sector_names[(i+2):j])

# aggregate our scd table
scd <- scd %>% mutate(s_code = as.character(s_code)) %>% filter(s_code !="R68A")
scd$s_code[scd$es_name=="Real estate activities"]<-"R68"
scd$s_name[scd$es_name=="Real estate activities"]<-"Real estate activities"
scd$Comments[scd$es_name=="Real estate activities"]<-NA


# Good that aggregation is done then. Keep only the aggregated version then.
rm(aggc,aggr,aggtc,aggtr,fc,fct,fd,fdt,fe,vm,x,xt,Z,Zt,Zr,Ztr,sector_codes,sector_names)
```

Then import and aggregate the ES data.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# import data
esd <- read_excel(file.path(efp,"ES by Industry in Norway.xlsx"), 
                 sheet = "USE IND (A38) - ES (7)_ADJ")[-c(1,2),-1] %>% 
  rename(es_sector = `...2`) %>%
  select(-c("Ecosystem services","Global climate regulation","...12")) %>%
  mutate(`Crop provision` = as.numeric(`Crop provision`),
         `Pollination` = as.numeric(`Pollination`),
         `Wood provision` = as.numeric(`Wood provision`),
         `Air filtration` = as.numeric(`Air filtration`),
         `Flood control` = as.numeric(`Flood control`),
         `Local climate regulation` = as.numeric(`Local climate regulation`),
         `Nature based tourism` = as.numeric(`Nature based tourism`))
esd[is.na(esd)]<-0

# now aggregate
esd <- esd %>% 
  left_join(scd,by=join_by(es_sector==es_name)) %>% 
  select(-c(Comments,es_sector)) %>%
  pivot_longer(-c(s_code,s_name),names_to="ES",values_to = "value") %>%
  group_by(s_code,s_name,ES) %>% summarise(value=sum(value)) %>%
  pivot_wider(names_from="ES",values_from="value") %>%
  mutate(s_name=factor(s_name,levels=sector_names_c)) %>%
  arrange(s_name)

# done. Mapping completed.
```

# 3 Calculations

## 3.1 Generate required matrices

Here we compute the leontief matrix based on Norwegian IOT.

```{r, results = 'hide', message = FALSE, warning=FALSE}
###### version w/o trade #######################################################
##### First the technical coefficients matrix
# first the inverse
xinv<-xr^-1
xinvv<-as.vector(xinv)
xinvvd<-diag(xinvv)
# then the matrix
a <- mat.mult(Zrc,xinvvd)
# clean up
rm(xinv,xinvv,xinvvd)
# check results. 
# check if any NAs. If so, then thats probably due to zero outputs. Confirm. Then turn NAs into zeros.
zocases<-paste(round(100*length(a[is.na(a)])/length(a),digits = 2),"%",sep=" ")
#a[is.na(a)]<-0

##### Then the Leontief matrix
# first we need an identity matrix
I<-diag(ncol(Zrc))
# then I minus the technical coefficients matrix
I_a<-I-a
# then the leontief inverse
leo<-solve(I_a)
# clean up
rm(I_a)

# ###### version with trade ######################################################
# ##### First the technical coefficients matrix
# # first the inverse
# xinv<-xtr^-1
# xinvv<-as.vector(xinv)
# xinvvd<-diag(xinvv)
# # then the matrix
# at <- mat.mult(Ztrc,xinvvd)
# # clean up
# rm(xinv,xinvv,xinvvd)
# # check results. 
# # check if any NAs. If so, then thats probably due to zero outputs. Confirm. Then turn NAs into zeros.
# zocasest<-paste(round(100*length(a[is.na(a)])/length(a),digits = 2),"%",sep=" ")
# #a[is.na(a)]<-0
# 
# ##### Then the Leontief matrix
# # first we need an identity matrix
# It<-diag(ncol(Ztrc))
# # then I minus the technical coefficients matrix
# I_a<-It-at
# # then the leontief inverse
# leot<-solve(I_a)
# # clean up
# rm(I_a)

```

## 3.2 Compute embodied ES

Here we compute the amount of ecosystem services embodied in final consumption by different entities, taking into account industrial structure in Norway.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# I implement the calculations in a loop
# across seven ES and three final demand categories
ld<-list()
for(i in 1:7){
  # get ES account
  esa<-(esd[,(i+2)]/xr) %>% as.matrix() %>% as.numeric() %>% matrix(nrow=1)
  ld[[i]]<- as.data.frame(matrix(ncol=6,nrow=length(sector_codes_c)))
  colnames(ld[[i]])<-c("ES","sector_c","sector_n","embodied_finaldem","embodied_exports","embodied_gcf")
  ld[[i]]$ES <- colnames(esd)[i+2]
  ld[[i]]$sector_c <- sector_codes_c
  ld[[i]]$sector_n <- sector_names_c
  ld[[i]]$embodied_finaldem <- as.vector(esa %*% leo %*% diag(as.vector(fdr)))
  ld[[i]]$embodied_exports <- as.vector(esa %*% leo %*% diag(as.vector(fer)))
  ld[[i]]$embodied_gcf <- as.vector(esa %*% leo %*% diag(as.vector(fcr)))
}
rdf <- do.call("rbind",ld)
rm(ld)

```

## 3.3 Aggregate results

So what we have now is a table of ecosystem service flows embodied in (1) final demand in Norway, (2) exports from Norway, (3) capital formation (investment into physical capital stock like roads, factories, machinery) in Norway. Our results are disaggregated by product, so we know what has the most embodied ecosystem service. I suggest we aggregate our product categories from 61 to a smaller, more digestible number. Then make some plots.

```{r, results = 'hide', message = FALSE, warning=FALSE}
# so first we make an aggregation table
adf<-as.data.frame(matrix(ncol=2,nrow=length(sector_codes_c)))
colnames(adf)<-c("sector_c","agg_groups")
adf$sector_c<-sector_codes_c
adf$agg_groups[1:3]<-"Agri., forestry, fish."
adf$agg_groups[4]<-"Mining incl. oil&gas extract."
adf$agg_groups[5:21]<-"Manufactured products"
adf$agg_groups[22:24]<-"Electricity etc."
adf$agg_groups[25]<-"Construction"
adf$agg_groups[c(26:28,35:51,56:61)]<-"Other services"
adf$agg_groups[29:33]<-"Transport"
adf$agg_groups[34]<-"Accommodation and food service"
adf$agg_groups[52:55]<-"Public services"

# Then aggregate
rdfp <- rdf %>% 
  left_join(adf,by=join_by(sector_c==sector_c)) %>% 
  pivot_longer(-c(ES,sector_c,sector_n,agg_groups),
               names_to="item",values_to = "value") %>%
  group_by(ES,agg_groups,item) %>% summarise(value=sum(value)) %>%
  mutate(agg_groups=factor(agg_groups,levels=c("Agri., forestry, fish.",
                                               "Mining incl. oil&gas extract.",
                                               "Manufactured products",
                                               "Electricity etc.",
                                               "Construction",
                                               "Transport",
                                               "Accommodation and food service",
                                               "Other services",
                                               "Public services"))) %>%
  mutate(item=recode(item,"embodied_exports" = "Exports","embodied_finaldem" = "Domestic Final Demand","embodied_gcf" = "Domestic Net Capital Formation")) %>%
  mutate(item = factor(item,levels=c("Domestic Final Demand","Exports","Domestic Net Capital Formation")))
```

# 4. Plot results

# 4.1 Plot function

We make a function for this.
```{r, results = 'hide', message = FALSE, warning=FALSE}
es_emb_plot<-function(ecos,unites){
  ggplot(rdfp %>% filter(ES==ecos),aes(y=value,x=agg_groups,fill=agg_groups)) +
  geom_bar(stat="identity") +
  scale_fill_viridis_d()+
  theme_bw()+
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        legend.title=element_blank())+
  labs(x="Aggregated product groups",
       title=paste("Final-product embodied",ecos),
       y=paste(unites))+
  facet_wrap(~item,nrow=1,scales="fixed")+
  guides(fill=guide_legend(nrow=3,byrow=TRUE))
}
```

# 4.2 Crop provision
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Crop provision",unites="k tonnes")
```

# 4.3 Pollination
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Pollination",unites="k tonnes")
```

# 4.4 Wood provision
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Wood provision",unites="k cubic metres")
```

# 4.5 Air filtration
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Air filtration",unites="Tonnes PM2.5")
```

# 4.6 Flood control
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Flood control",unites="hectares")
```

# 4.7 Local climate regulation
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Local climate regulation",unites="degrees")
```

# 4.8 Nature-based tourism
```{r,message = FALSE, results = 'hide'}
es_emb_plot(ecos="Nature based tourism",unites="overnight stays")
```

# 5. Conclusion and outlook

Tbd.


